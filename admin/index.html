<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Admin ‚Äî VetMobil</title>
</head>
<body>
  <!-- Decap CMS -->
  <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>

  <!-- UI admin -->
  <button id="rebuildIndexBtn">üîÑ Rebuild articole</button>
  <p id="rebuildStatus" style="font:14px/1.4 sans-serif;"></p>

  <hr/>
  <h2>Manager articole (live)</h2>

  <button id="reloadListBtn">‚Üª Re√ÆncarcƒÉ lista</button>
  <p id="listStatus" style="font:14px/1.4 sans-serif; margin:8px 0;"></p>

  <table id="articlesTable" border="1" cellpadding="6" cellspacing="0" style="border-collapse:collapse; font:14px/1.4 sans-serif; width:100%; max-width:900px;">
    <thead>
      <tr>
        <th style="text-align:left;">Titlu</th>
        <th style="text-align:left;">Slug</th>
        <th style="text-align:left;">Fi»ôier</th>
        <th>Ac»õiuni</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const API_BASE = 'https://vetmobil.ro/cms-api';

    // 1) Salvare prin Decap -> PHP + rebuild
    CMS.registerEventListener({
      name: 'postSave',
      handler: async ({ entry }) => {
        try {
          const data = entry.get('data').toJS();
          data.slug = entry.get('slug');

          const saveRes = await fetch(`${API_BASE}/articles.php`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
          const saveJson = await saveRes.json();
          console.log('‚úÖ Articol salvat pe server:', saveJson);

          await fetch(`${API_BASE}/rebuild-trigger.php`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: '{}'
          });

          alert('Articolul a fost salvat. DacƒÉ nu apare imediat pe site, apasƒÉ ‚ÄûRebuild articole‚Äù.');
        } catch (err) {
          console.error('‚ùå Eroare la salvare:', err);
          alert('Eroare la salvare. Vezi consola (F12) ‚Üí Console.');
        }
      }
    });

    // 2) Rebuild buton
    const rebuildBtn = document.getElementById('rebuildIndexBtn');
    const rebuildOut = document.getElementById('rebuildStatus');
    rebuildBtn.addEventListener('click', async () => {
      rebuildBtn.disabled = true; rebuildOut.textContent = 'Se reconstruie»ôte...';
      try {
        const r = await fetch(`${API_BASE}/rebuild-trigger.php`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: '{}'
        });
        const data = await r.json();
        if (data.ok) {
          rebuildOut.textContent = `Gata. ${data.count ?? '?'} articole indexate.`;
        } else {
          rebuildOut.textContent = 'Eroare: ' + (data.error || 'necunoscutƒÉ');
        }
      } catch (e) {
        rebuildOut.textContent = 'Eroare de re»õea: ' + e.message;
      } finally {
        rebuildBtn.disabled = false;
      }
    });

    // 3) Manager articole (listare + »ôtergere)
    const listBtn  = document.getElementById('reloadListBtn');
    const listOut  = document.getElementById('listStatus');
    const tbody    = document.querySelector('#articlesTable tbody');

    function escapeHtml(s) {
      return (s || '').replace(/[&<>"']/g, c => (
        { '&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;', "'":'&#39;' }[c]
      ));
    }

    async function loadArticles() {
      listOut.textContent = 'Se √ÆncarcƒÉ...';
      tbody.innerHTML = '';
      try {
        const r = await fetch(`${API_BASE}/articles.php`, {
          method: 'GET',
          mode: 'cors',
          cache: 'no-store',
          headers: { 'Accept': 'application/json' }
        });
        if (!r.ok) throw new Error(`HTTP ${r.status}`);
        const data = await r.json();
        if (!data || !Array.isArray(data.items)) {
          listOut.textContent = 'Nu am putut √ÆncƒÉrca lista (format necunoscut).';
          return;
        }
        listOut.textContent = `Gata. ${data.count ?? data.items.length} articole.`;

        for (const item of data.items) {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${escapeHtml(item.title || '')}</td>
            <td>${escapeHtml(item.slug || '')}</td>
            <td>${escapeHtml(item.file || '')}</td>
            <td>${item.slug ? `<button class="del" data-slug="${escapeHtml(item.slug)}">»òterge</button>` : '<em>(fƒÉrƒÉ slug)</em>'}</td>
          `;
          tbody.appendChild(tr);
        }

        tbody.querySelectorAll('button.del').forEach(btn => {
          btn.addEventListener('click', async () => {
            const slug = btn.getAttribute('data-slug');
            if (!slug) return;
            if (!confirm(`»òtergi articolul: ${slug}?`)) return;
            btn.disabled = true; btn.textContent = '...';
            try {
              const delRes = await fetch(`${API_BASE}/articles.php`, {
                method: 'POST',
                mode: 'cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'delete', slug })
              });
              const delJson = await delRes.json();
              if (delJson.status === 'deleted') {
                await fetch(`${API_BASE}/rebuild-trigger.php`, {
                  method: 'POST',
                  mode: 'cors',
                  headers: { 'Content-Type': 'application/json' },
                  body: '{}'
                });
                await loadArticles();
              } else {
                alert('Eroare la »ôtergere: ' + (delJson.error || 'necunoscutƒÉ'));
              }
            } catch (e) {
              alert('Eroare re»õea la »ôtergere: ' + e.message);
            } finally {
              btn.disabled = false; btn.textContent = '»òterge';
            }
          });
        });

      } catch (e) {
        console.error(e);
        listOut.textContent = 'Eroare re»õea: ' + e.message;
      }
    }

    listBtn.addEventListener('click', loadArticles);
    loadArticles(); // √ÆncarcƒÉ automat
  });
  </script>
  <!-- Uploader rapid pentru imagini (direct pe server) -->
<style>
  #quick-uploader {
    position: fixed; right: 16px; bottom: 16px; z-index: 9999;
    background:#0ea5e9; color:#fff; padding:10px 12px; border-radius:10px;
    box-shadow:0 8px 24px rgba(0,0,0,.2); font:14px/1.1 system-ui, sans-serif;
    cursor:pointer;
  }
  #quick-uploader input { display:none; }
  #quick-uploader small { display:block; opacity:.85; font-size:12px; }
</style>
<div id="quick-uploader" title="UrcƒÉ imagine √Æn assets/uploads">
  üì§ UrcƒÉ imagine
  <small>copiazƒÉ automat URL-ul</small>
  <input id="quick-file" type="file" accept="image/*">
</div>
<script>
(function() {
  const API = 'https://vetmobil.ro/cms-api/articles.php'; // upload endpoint-ul nostru
  const box = document.getElementById('quick-uploader');
  const file = document.getElementById('quick-file');

  function sticker(msg, ok=true){
    box.style.background = ok ? '#10b981' : '#ef4444';
    box.innerHTML = (ok ? '‚úÖ ' : '‚ö†Ô∏è ') + msg + '<small>click pentru altƒÉ imagine</small><input id="quick-file" type="file" accept="image/*" style="display:none">';
    // re-leagƒÉ inputul
    const newFile = box.querySelector('#quick-file');
    newFile.addEventListener('change', onPick);
  }

  async function onPick(e){
    const f = e.target.files && e.target.files[0];
    if(!f) return;
    try{
      box.style.background = '#0ea5e9';
      box.innerHTML = '‚è≥ √éncarc...' + '<small>te rog a»ôteaptƒÉ</small><input id="quick-file" type="file" accept="image/*" style="display:none">';
      const fd = new FormData();
      fd.append('file', f);
      const r = await fetch(API, { method:'POST', body:fd, credentials:'omit' });
      const txt = await r.text();
      // API-ul nostru √Æntoarce UN STRING JSON cu calea publicƒÉ
      // ex: "/assets/uploads/1693599999-nume.png"
      let url = null;
      try { url = JSON.parse(txt); } catch(_) {}
      if (typeof url !== 'string') throw new Error('RƒÉspuns nea»ôteptat: ' + txt);

      // CopiazƒÉ √Æn clipboard
      try { await navigator.clipboard.writeText(url); } catch(_) {}

      // √éncearcƒÉ sƒÉ bage URL-ul direct √Æn c√¢mpul "Imagine" (controlul de URL)
      try {
        // CautƒÉ un input text vizibil √Æn cardul controlului de imagine
        const candidates = Array.from(document.querySelectorAll('input[type="text"], input[type="url"]'));
        // ia prima care e vizibilƒÉ √Æn editor (nu √Æn sidebar)
        const target = candidates.find(el => el.offsetParent && el.closest('[data-testid="editor-control"]'));
        if (target) {
          target.focus();
          target.value = url;
          target.dispatchEvent(new Event('input', { bubbles:true }));
          target.dispatchEvent(new Event('change', { bubbles:true }));
        }
      } catch(_) {}

      sticker('√éncƒÉrcat! URL √Æn clipboard');
    } catch(err){
      console.error(err);
      sticker('Eroare la upload', false);
    }
  }

  box.addEventListener('click', () => file.click());
  file.addEventListener('change', onPick);
})();
</script>
</body>
</html>
