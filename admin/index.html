<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Admin â€” VetMobil</title>
</head>
<body>
  <!-- Decap CMS -->
  <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>

  <!-- UI admin -->
  <button id="rebuildIndexBtn">ðŸ”„ Rebuild articole</button>
  <p id="rebuildStatus" style="font:14px/1.4 sans-serif;"></p>

  <hr/>
  <h2>Manager articole (live)</h2>

  <button id="reloadListBtn">â†» ReÃ®ncarcÄƒ lista</button>
  <p id="listStatus" style="font:14px/1.4 sans-serif; margin:8px 0;"></p>

  <table id="articlesTable" border="1" cellpadding="6" cellspacing="0" style="border-collapse:collapse; font:14px/1.4 sans-serif; width:100%; max-width:900px;">
    <thead>
      <tr>
        <th style="text-align:left;">Titlu</th>
        <th style="text-align:left;">Slug</th>
        <th style="text-align:left;">FiÈ™ier</th>
        <th>AcÈ›iuni</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const API_BASE = 'https://vetmobil.ro/cms-api';

    // 1) Salvare prin Decap -> PHP + rebuild
    CMS.registerEventListener({
      name: 'postSave',
      handler: async ({ entry }) => {
        try {
          const data = entry.get('data').toJS();
          data.slug = entry.get('slug');

          const saveRes = await fetch(`${API_BASE}/articles.php`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
          const saveJson = await saveRes.json();
          console.log('âœ… Articol salvat pe server:', saveJson);

          await fetch(`${API_BASE}/rebuild-trigger.php`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: '{}'
          });

          alert('Articolul a fost salvat. DacÄƒ nu apare imediat pe site, apasÄƒ â€žRebuild articoleâ€.');
        } catch (err) {
          console.error('âŒ Eroare la salvare:', err);
          alert('Eroare la salvare. Vezi consola (F12) â†’ Console.');
        }
      }
    });

    // 2) Rebuild buton
    const rebuildBtn = document.getElementById('rebuildIndexBtn');
    const rebuildOut = document.getElementById('rebuildStatus');
    rebuildBtn.addEventListener('click', async () => {
      rebuildBtn.disabled = true; rebuildOut.textContent = 'Se reconstruieÈ™te...';
      try {
        const r = await fetch(`${API_BASE}/rebuild-trigger.php`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: '{}'
        });
        const data = await r.json();
        if (data.ok) {
          rebuildOut.textContent = `Gata. ${data.count ?? '?'} articole indexate.`;
        } else {
          rebuildOut.textContent = 'Eroare: ' + (data.error || 'necunoscutÄƒ');
        }
      } catch (e) {
        rebuildOut.textContent = 'Eroare de reÈ›ea: ' + e.message;
      } finally {
        rebuildBtn.disabled = false;
      }
    });

    // 3) Manager articole (listare + È™tergere)
    const listBtn  = document.getElementById('reloadListBtn');
    const listOut  = document.getElementById('listStatus');
    const tbody    = document.querySelector('#articlesTable tbody');

    function escapeHtml(s) {
      return (s || '').replace(/[&<>"']/g, c => (
        { '&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;', "'":'&#39;' }[c]
      ));
    }

    async function loadArticles() {
      listOut.textContent = 'Se Ã®ncarcÄƒ...';
      tbody.innerHTML = '';
      try {
        const r = await fetch(`${API_BASE}/articles.php`, {
          method: 'GET',
          mode: 'cors',
          cache: 'no-store',
          headers: { 'Accept': 'application/json' }
        });
        if (!r.ok) throw new Error(`HTTP ${r.status}`);
        const data = await r.json();
        if (!data || !Array.isArray(data.items)) {
          listOut.textContent = 'Nu am putut Ã®ncÄƒrca lista (format necunoscut).';
          return;
        }
        listOut.textContent = `Gata. ${data.count ?? data.items.length} articole.`;

        for (const item of data.items) {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${escapeHtml(item.title || '')}</td>
            <td>${escapeHtml(item.slug || '')}</td>
            <td>${escapeHtml(item.file || '')}</td>
            <td>${item.slug ? `<button class="del" data-slug="${escapeHtml(item.slug)}">È˜terge</button>` : '<em>(fÄƒrÄƒ slug)</em>'}</td>
          `;
          tbody.appendChild(tr);
        }

        tbody.querySelectorAll('button.del').forEach(btn => {
          btn.addEventListener('click', async () => {
            const slug = btn.getAttribute('data-slug');
            if (!slug) return;
            if (!confirm(`È˜tergi articolul: ${slug}?`)) return;
            btn.disabled = true; btn.textContent = '...';
            try {
              const delRes = await fetch(`${API_BASE}/articles.php`, {
                method: 'POST',
                mode: 'cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'delete', slug })
              });
              const delJson = await delRes.json();
              if (delJson.status === 'deleted') {
                await fetch(`${API_BASE}/rebuild-trigger.php`, {
                  method: 'POST',
                  mode: 'cors',
                  headers: { 'Content-Type': 'application/json' },
                  body: '{}'
                });
                await loadArticles();
              } else {
                alert('Eroare la È™tergere: ' + (delJson.error || 'necunoscutÄƒ'));
              }
            } catch (e) {
              alert('Eroare reÈ›ea la È™tergere: ' + e.message);
            } finally {
              btn.disabled = false; btn.textContent = 'È˜terge';
            }
          });
        });

      } catch (e) {
        console.error(e);
        listOut.textContent = 'Eroare reÈ›ea: ' + e.message;
      }
    }

    listBtn.addEventListener('click', loadArticles);
    loadArticles(); // Ã®ncarcÄƒ automat
  });
  </script>
</body>
</html>
